<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ThingSpeak Robot Tracker</title>
  <link rel="stylesheet" href="leaflet.css" />
  
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    .attribution { position: absolute; right: 8px; bottom: 8px; z-index: 1000; background: rgba(255,255,255,0.8); padding:6px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="attribution">Live tracker — polls ThingSpeak every 15s</div>

<script src="leaflet.js"></script>

<script>
/* -------- CONFIG -------- */
const CHANNEL_ID = 3260238; // آی‌دی کانال تو که فرستاده بودی
const FIELD_LAT = 'field1'; 
const FIELD_LON = 'field2'; 
const POLL_INTERVAL_MS = 15000; 
const DECIMALS = 6; 

function fmt(n){ return Number(Number(n).toFixed(DECIMALS)); }

function buildUrl(){
  // اگه کانالت Private هست، ته این آدرس عبارت &api_key=YOUR_READ_KEY رو اضافه کن
  return `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`;
}

const map = L.map('map', {zoomControl:true}).setView([0,0], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker = null;
let lastPos = null;
let animDuration = 1000; 

function setMarker(lat, lon){
  const latf = fmt(lat), lonf = fmt(lon);
  const newLatLng = L.latLng(latf, lonf);
  if(!marker){
    marker = L.marker(newLatLng).addTo(map);
    map.setView(newLatLng, 17);
    lastPos = newLatLng;
    return;
  }
  const start = lastPos;
  const end = newLatLng;
  const t0 = performance.now();
  function step(now){
    const t = Math.min(1, (now - t0)/animDuration);
    const lat = start.lat + (end.lat - start.lat) * t;
    const lng = start.lng + (end.lng - start.lng) * t;
    marker.setLatLng([lat,lng]);
    if(t < 1) requestAnimationFrame(step);
    else lastPos = end;
  }
  requestAnimationFrame(step);
  map.panTo(newLatLng, {animate: true, duration: 0.8});
}

async function pollOnce(){
  try{
    const url = buildUrl();
    const r = await fetch(url, {cache: "no-store"});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const json = await r.json();
    if(!json || !json.feeds || json.feeds.length===0) return;
    const feed = json.feeds[0];
    let lat = Number(feed.field1);
    let lon = Number(feed.field2);
    if(Number.isFinite(lat) && Number.isFinite(lon)){
      setMarker(lat, lon);
    }
  }catch(err){
    console.error('Poll error', err);
  }
}

pollOnce();
setInterval(pollOnce, POLL_INTERVAL_MS);
</script>
</body>
</html>
