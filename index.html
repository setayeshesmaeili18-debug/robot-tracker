<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="utf-8" />
    <title>SafeGuard Robot Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html, #map { height: 100%; margin: 0; padding: 0; font-family: Tahoma, sans-serif; }
        #overlay {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); padding: 10px 15px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #007bff; direction: rtl;
        }
        .status-dot { height: 10px; width: 10px; background-color: #28a745; border-radius: 50%; display: inline-block; margin-left: 5px; }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-weight: bold; color: #007bff;">راداربند هوشمند <span class="status-dot"></span></div>
    <div id="coords" style="font-size: 11px; margin-top: 5px; color: #555;">در حال دریافت سیگنال...</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const CHANNEL_ID = "3260238";
    const UPDATE_INTERVAL = 15000; // 15 ثانیه

    // تنظیم اولیه نقشه
    const map = L.map('map', { zoomControl: false }).setView([35.7, 51.4], 15);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // لایه نقشه (می‌تونی بعداً به Satellite تغییر بدی)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let marker = null;
    let lastLatLng = null;

    async function updateTracker() {
        try {
            const response = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`);
            const data = await response.json();
            
            if (data.feeds && data.feeds.length > 0) {
                const feed = data.feeds[0];
                const lat = parseFloat(feed.field1);
                const lon = parseFloat(feed.field2);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const newLatLng = [lat, lon];

                    if (!marker) {
                        // اولین بار: ساخت مارکر
                        marker = L.marker(newLatLng).addTo(map);
                        map.setView(newLatLng, 17);
                    } else {
                        // حرکت نرم به موقعیت جدید
                        marker.setLatLng(newLatLng);
                        map.panTo(newLatLng, { animate: true, duration: 1.0 });
                    }
                    
                    document.getElementById('coords').innerHTML = 
                        `عرض: ${lat.toFixed(5)}<br>طول: ${lon.toFixed(5)}<br>بروزرسانی: ${new Date().toLocaleTimeString('fa-IR')}`;
                }
            }
        } catch (error) {
            console.error("خطا در ارتباط:", error);
            document.getElementById('coords').innerText = "خطا در اتصال به سرور";
        }
    }

    // شروع حلقه بروزرسانی
    setInterval(updateTracker, UPDATE_INTERVAL);
    updateTracker();
</script>

</body>
</html>
