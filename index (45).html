<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Safe Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; background: #eee; }
    .status { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 5px 10px; border-radius: 4px; font-family: sans-serif; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="status" id="stat">Connecting...</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const CHANNEL_ID = 3260238;
    const map = L.map('map').setView([35.7, 51.4], 13);
    let marker = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    async function updateMap() {
      try {
        const response = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`);
        const data = await response.json();
        const feed = data.feeds[0];
        const lat = parseFloat(feed.field1);
        const lon = parseFloat(feed.field2);

        if (!isNaN(lat) && !isNaN(lon)) {
          const pos = [lat, lon];
          if (!marker) {
            marker = L.marker(pos).addTo(map);
            map.setView(pos, 16);
          } else {
            marker.setLatLng(pos); // جابه‌جایی مستقیم بدون Eval
          }
          document.getElementById('stat').innerText = 'Last update: ' + new Date().toLocaleTimeString();
        }
      } catch (e) {
        document.getElementById('stat').innerText = 'Error connection';
      }
    }

    setInterval(updateMap, 15000);
    updateMap();
  </script>
</body>
</html>
